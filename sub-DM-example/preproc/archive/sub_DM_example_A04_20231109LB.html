<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB 2022b"><title>LOADING TOOLBOXES</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.8px; min-height: 0px; white-space: pre-wrap; color: rgb(192, 76, 11); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: 400; text-align: left;  }
.CodeBlock { background-color: #F5F5F5; margin: 10px 0 10px 0; }
.S1 { border-left: 0.994318px solid rgb(191, 191, 191); border-right: 0.994318px solid rgb(191, 191, 191); border-top: 0.994318px solid rgb(191, 191, 191); border-bottom: 0px none rgb(33, 33, 33); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S2 { border-left: 0.994318px solid rgb(191, 191, 191); border-right: 0.994318px solid rgb(191, 191, 191); border-top: 0px none rgb(33, 33, 33); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S3 { border-left: 0.994318px solid rgb(191, 191, 191); border-right: 0.994318px solid rgb(191, 191, 191); border-top: 0px none rgb(33, 33, 33); border-bottom: 0.994318px solid rgb(191, 191, 191); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S4 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.S5 { border-left: 0.994318px solid rgb(191, 191, 191); border-right: 0.994318px solid rgb(191, 191, 191); border-top: 0px none rgb(33, 33, 33); border-bottom: 0.994318px solid rgb(191, 191, 191); border-radius: 0px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S6 { color: rgb(33, 33, 33); padding: 10px 0px 6px 17px; background: rgb(255, 255, 255) none repeat scroll 0% 0% / auto padding-box border-box; font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px; overflow-x: hidden; line-height: 17.234px;  }
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsErrorElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsErrorElement .diagnosticMessage-errorType {    overflow: auto;}
.embeddedOutputsErrorElement.inlineElement {}
.embeddedOutputsErrorElement.rightPaneElement {}
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsWarningElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsWarningElement .diagnosticMessage-warningType {    overflow: auto;}
.embeddedOutputsWarningElement.inlineElement {}
.embeddedOutputsWarningElement.rightPaneElement {}
/* Copyright 2015-2019 The MathWorks, Inc. *//* In this file, styles are not scoped to rtcContainer since they could be in the Dojo Tooltip */.diagnosticMessage-wrapper {    font-family: Menlo, Monaco, Consolas, "Courier New", monospace;    font-size: 12px;}
.diagnosticMessage-wrapper.diagnosticMessage-warningType {    color: rgb(255,100,0);}
.diagnosticMessage-wrapper.diagnosticMessage-warningType a {    color: rgb(255,100,0);    text-decoration: underline;}
.diagnosticMessage-wrapper.diagnosticMessage-errorType {    color: rgb(230,0,0);}
.diagnosticMessage-wrapper.diagnosticMessage-errorType a {    color: rgb(230,0,0);    text-decoration: underline;}
.diagnosticMessage-wrapper .diagnosticMessage-messagePart,.diagnosticMessage-wrapper .diagnosticMessage-causePart {    white-space: pre-wrap;}
.diagnosticMessage-wrapper .diagnosticMessage-stackPart {    white-space: pre;}
.embeddedOutputsTextElement,.embeddedOutputsVariableStringElement {    white-space: pre;    word-wrap:  initial;    min-height: 18px;    max-height: 550px;}
.embeddedOutputsTextElement .textElement,.embeddedOutputsVariableStringElement .textElement {    overflow: auto;}
.textElement,.rtcDataTipElement .textElement {    padding-top: 2px;}
.embeddedOutputsTextElement.inlineElement,.embeddedOutputsVariableStringElement.inlineElement {}
.inlineElement .textElement {}
.embeddedOutputsTextElement.rightPaneElement,.embeddedOutputsVariableStringElement.rightPaneElement {    min-height: 16px;}
.rightPaneElement .textElement {    padding-top: 2px;    padding-left: 9px;}
.S7 { border-left: 0.994318px solid rgb(191, 191, 191); border-right: 0.994318px solid rgb(191, 191, 191); border-top: 0.994318px solid rgb(191, 191, 191); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S8 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S9 { margin: 10px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S10 { margin: 10px 0px 20px; padding-left: 0px; font-family: Helvetica, Arial, sans-serif; font-size: 14px;  }
.S11 { margin-left: 56px; line-height: 21px; min-height: 0px; text-align: left; white-space: pre-wrap;  }</style></head><body><div class = rtcContent><h1  class = 'S0'><span>LOADING TOOLBOXES</span></h1><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >ft_defaults</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >bml_defaults</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >format </span><span style="color: rgb(167, 9, 245);">long</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >clear</span></span></div></div></div><h2  class = 'S4'><span>DEFINING PATHS</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >SUBJECT=</span><span style="color: rgb(167, 9, 245);">'DM10XX'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >SESSION=</span><span style="color: rgb(167, 9, 245);">'intraop'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% this first part of this script is not task-specific</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% TASK='lombard';</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_DATASET = </span><span style="color: rgb(167, 9, 245);">'Y:\DBS'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_DER = [PATH_DATASET filesep </span><span style="color: rgb(167, 9, 245);">'derivatives'</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_DER_SUB = [PATH_DER filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT];  </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_PREPROC = [PATH_DER_SUB filesep </span><span style="color: rgb(167, 9, 245);">'preproc'</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_ANNOT = [PATH_DER_SUB filesep </span><span style="color: rgb(167, 9, 245);">'annot'</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_SRC = [PATH_DATASET filesep </span><span style="color: rgb(167, 9, 245);">'sourcedata'</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_SRC_SUB = [PATH_SRC filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT];   </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_RIPPLE = [PATH_SRC_SUB filesep </span><span style="color: rgb(167, 9, 245);">'ses-intraop' </span><span >filesep </span><span style="color: rgb(167, 9, 245);">'ripple'</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_ANALOG = [PATH_SRC_SUB filesep </span><span style="color: rgb(167, 9, 245);">'ses-intraop' </span><span >filesep </span><span style="color: rgb(167, 9, 245);">'analog'</span><span >];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_ALHAOMEGA = [PATH_SRC_SUB filesep </span><span style="color: rgb(167, 9, 245);">'ses-intraop' </span><span >filesep </span><span style="color: rgb(167, 9, 245);">'alphaomega'</span><span >]; </span><span style="color: rgb(0, 128, 19);">%path to neuroomega's mpx files.</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_ALHAOMEGA_MAT = [PATH_ALHAOMEGA]; </span><span style="color: rgb(0, 128, 19);">%path to neuroomega's converted mat files.</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATH_AUDIO_DER = [PATH_DER_SUB filesep </span><span style="color: rgb(167, 9, 245);">'aec'</span><span >]; </span><span style="color: rgb(0, 128, 19);">%path to acoustic echo cancelling folder</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATHS_AUDIO_SRC = strcat(PATH_SRC_SUB,filesep,{</span><span style="color: rgb(167, 9, 245);">'ses-training'</span><span >;</span><span style="color: rgb(167, 9, 245);">'ses-preop'</span><span >;</span><span style="color: rgb(167, 9, 245);">'ses-intraop'</span><span >},filesep,</span><span style="color: rgb(167, 9, 245);">'audio'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >PATHS_TASK = strcat(PATH_SRC_SUB,filesep,{</span><span style="color: rgb(167, 9, 245);">'ses-training'</span><span >;</span><span style="color: rgb(167, 9, 245);">'ses-preop'</span><span >;</span><span style="color: rgb(167, 9, 245);">'ses-intraop'</span><span >},filesep,</span><span style="color: rgb(167, 9, 245);">'task'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% loading annotation tables</span></span></div></div><div class="inlineWrapper outputs"><div  class = 'S5'><span style="white-space: pre"><span >events_files = bml_annot_read_tsv([PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_events-files.tsv'</span><span >]);</span></span></div><div  class = 'S6'><div class="inlineElement eoOutputWrapper embeddedOutputsErrorElement" uid="F77F9823" prevent-scroll="true" data-testid="output_0" style="width: 1044.03px; white-space: normal; font-style: normal; color: rgb(33, 33, 33); font-size: 12px;"><div class="diagnosticMessage-wrapper diagnosticMessage-errorType eoOutputContent" data-width="1014" data-height="75" data-hashorizontaloverflow="false" style="max-height: 261px; white-space: normal; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"><div class="diagnosticMessage-messagePart" style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">Error using readtable<br style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">Unable to find or open 'Y:\DBS/derivatives/sub-DM10XX/annot/sub-DM10XX_events-files.tsv'. Check the path and filename or file permissions.</div><div class="diagnosticMessage-stackPart" style="white-space: pre; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"><br style="white-space: pre; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">Error in bml_annot_read_tsv (line 23)<br style="white-space: pre; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">annot = readtable(filename,varargin{:});</div></div></div></div></div><div class="inlineWrapper"><div  class = 'S7'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% events_files.path = strrep(events_files.path,'/Volumes/Nexus4','Y:');</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >session = bml_annot_read_tsv([PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_sessions.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >runs = bml_annot_read_tsv([PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_runs.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >cd(PATH_PREPROC)</span></span></div></div></div><h2  class = 'S4'><span>LOADING HEADER INFORMATION</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.path=PATH_RIPPLE;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.pattern=</span><span style="color: rgb(167, 9, 245);">'*.nev'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.filetype=</span><span style="color: rgb(167, 9, 245);">'trellis.nev'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nev=bml_info_raw(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nev.basename = strrep(info_nev.name,</span><span style="color: rgb(167, 9, 245);">'.nev'</span><span >,</span><span style="color: rgb(167, 9, 245);">''</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.path=PATH_RIPPLE;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.pattern=</span><span style="color: rgb(167, 9, 245);">'*.ns5'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.filetype=</span><span style="color: rgb(167, 9, 245);">'trellis.ns5'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_ns5=bml_info_raw(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_ns5.basename = strrep(info_ns5.name,</span><span style="color: rgb(167, 9, 245);">'.ns5'</span><span >,</span><span style="color: rgb(167, 9, 245);">''</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.path=PATH_RIPPLE;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.pattern=</span><span style="color: rgb(167, 9, 245);">'*.nf3'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.filetype=</span><span style="color: rgb(167, 9, 245);">'trellis.nf3'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf3=bml_info_raw(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf3.chantype(:) = {</span><span style="color: rgb(167, 9, 245);">'hires'</span><span >};</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf3.basename = strrep(info_nf3.name,</span><span style="color: rgb(167, 9, 245);">'.nf3'</span><span >,</span><span style="color: rgb(167, 9, 245);">''</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.path=PATH_RIPPLE;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.pattern=</span><span style="color: rgb(167, 9, 245);">'*.nf6'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.filetype=</span><span style="color: rgb(167, 9, 245);">'trellis.nf6'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf6=bml_info_raw(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf6.chantype(:) = {</span><span style="color: rgb(167, 9, 245);">'hifreq'</span><span >};</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf6.basename = strrep(info_nf6.name,</span><span style="color: rgb(167, 9, 245);">'.nf6'</span><span >,</span><span style="color: rgb(167, 9, 245);">''</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.mpx_path=PATH_ALHAOMEGA;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.path=PATH_ALHAOMEGA_MAT;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.filetype=</span><span style="color: rgb(167, 9, 245);">'neuroomega.mat'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.chantype=</span><span style="color: rgb(167, 9, 245);">'analog'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_neuroomega=bml_neuroomega_info_raw(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_neuroomega.basename = strrep(info_neuroomega.name,</span><span style="color: rgb(167, 9, 245);">'.mat'</span><span >,</span><span style="color: rgb(167, 9, 245);">''</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav_src=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav_src_renamed=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">for </span><span >i=1:length(PATHS_AUDIO_SRC)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    cfg.path=PATHS_AUDIO_SRC{i};</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    cfg.pattern=</span><span style="color: rgb(167, 9, 245);">'ZOOM*/*.wav'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    cfg.filetype=</span><span style="color: rgb(167, 9, 245);">'audio.wav'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    info_wav_src=bml_annot_rowbind(info_wav_src,bml_info_raw(cfg));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.pattern=</span><span style="color: rgb(167, 9, 245);">'sub-*.wav'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    info_wav_src_renamed=bml_annot_rowbind(info_wav_src_renamed,bml_info_raw(cfg));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav_src.basename = strrep(info_wav_src.name,</span><span style="color: rgb(167, 9, 245);">'.WAV'</span><span >,</span><span style="color: rgb(167, 9, 245);">''</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav_src_renamed.basename = strrep(info_wav_src_renamed.name,</span><span style="color: rgb(167, 9, 245);">'.wav'</span><span >,</span><span style="color: rgb(167, 9, 245);">''</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.path=PATH_AUDIO_DER;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.pattern=</span><span style="color: rgb(167, 9, 245);">'*.wav'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.filetype=</span><span style="color: rgb(167, 9, 245);">'audio.wav'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav=bml_info_raw(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.basename = strrep(info_wav.name,</span><span style="color: rgb(167, 9, 245);">'.wav'</span><span >,</span><span style="color: rgb(167, 9, 245);">''</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav = info_wav(~ismember(info_wav.name,info_wav_src_renamed.name),:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav = bml_annot_rowbind(info_wav_src_renamed,info_wav);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% Saving files information table with OS times</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_orig = bml_annot_rowbind(info_ns5,info_nf3,info_nf6,info_nev,info_neuroomega,info_wav,info_wav_src);</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >bml_annot_write_tsv(info_orig, [PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION </span><span style="color: rgb(167, 9, 245);">'_data-files-orig.tsv'</span><span >]);</span></span></div></div></div><h2  class = 'S4'><span>ALIGNING TRELLIS FILES TO EVENTS BY SCRIPTS (NO TIME WARPING)</span></h2><div  class = 'S8'><span>looping through nev files</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >info_nev.delta_t(:) = nan;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nev.min_cost(:) = nan;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nev.n(:) = nan;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">for </span><span >i=1:height(info_nev)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(0, 128, 19);">%selecting events files that correspond to this nev file. Doing this by</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(0, 128, 19);">%coarse time</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    nev_events_files = bml_annot_filter(events_files,info_nev(i,:));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">if </span><span >~isempty(nev_events_files)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        task_events = table();</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">for </span><span >j = 1:height(nev_events_files)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(0, 128, 19);">% changed LB 20231019, sync file and lombard file couldn't be</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(0, 128, 19);">% concatenated because sync.stim_file was all nans</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            events_tmp = bml_annot_read_tsv(fullfile(nev_events_files.path{j},nev_events_files.filename{j})); </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">if </span><span >isnumeric(events_tmp.stim_file) &amp;&amp; all(isnan(events_tmp.stim_file)); events_tmp.stim_file = repmat({</span><span style="color: rgb(167, 9, 245);">''</span><span >}, height(events_tmp), 1); </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            task_events = bml_annot_rowbind(task_events, events_tmp);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%loading events from nev file</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        E = ft_read_event(fullfile(info_nev.folder{i},info_nev.name{i}),</span><span style="color: rgb(167, 9, 245);">'detectflank'</span><span >,</span><span style="color: rgb(167, 9, 245);">'both'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        hdr = ft_read_header(fullfile(info_nev.folder{i},info_nev.name{i}));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        cfg=[]; cfg.Fs = 1; </span><span style="color: rgb(0, 128, 19);">%already in seconds</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        cfg.starts = info_nev.starts(i);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        nev = bml_event2annot(cfg,E);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        nev.value = nev.value - 1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        nev.sample = round(nev.starts .* hdr.Fs);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% plot(nev.starts,nev.starts - task_events.starts)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%Aligning blackrock to presenation task to get GTC. No timewarping.</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        cfg.scan = 100;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        [slave_delta_t, min_cost, warpfactor] = bml_timealign_annot(cfg, task_events, nev);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        info_nev.delta_t(i)=slave_delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        info_nev.min_cost(i)=min_cost;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        info_nev.n(i)=height(nev);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        fprintf(</span><span style="color: rgb(167, 9, 245);">'%f sec, min cost = %f\n'</span><span >, slave_delta_t, min_cost)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%adjusting ripple files</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nev.delta_t(ismissing(info_nev.delta_t)) = 0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.keys = </span><span style="color: rgb(167, 9, 245);">'basename'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_ns5 = bml_annot_left_join(cfg,info_ns5,info_nev(:,{</span><span style="color: rgb(167, 9, 245);">'basename'</span><span >,</span><span style="color: rgb(167, 9, 245);">'delta_t'</span><span >}));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf3 = bml_annot_left_join(cfg,info_nf3,info_nev(:,{</span><span style="color: rgb(167, 9, 245);">'basename'</span><span >,</span><span style="color: rgb(167, 9, 245);">'delta_t'</span><span >}));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf6 = bml_annot_left_join(cfg,info_nf6,info_nev(:,{</span><span style="color: rgb(167, 9, 245);">'basename'</span><span >,</span><span style="color: rgb(167, 9, 245);">'delta_t'</span><span >}));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nev.starts = info_nev.starts + info_nev.delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nev.ends = info_nev.ends + info_nev.delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_ns5.starts = info_ns5.starts + info_ns5.delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_ns5.ends = info_ns5.ends + info_ns5.delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf3.starts = info_nf3.starts + info_nf3.delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf3.ends = info_nf3.ends + info_nf3.delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf6.starts = info_nf6.starts + info_nf6.delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_nf6.ends = info_nf6.ends + info_nf6.delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi_nev = bml_roi_table(info_nev,</span><span style="color: rgb(167, 9, 245);">'trellis'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi_ns5 = bml_roi_table(info_ns5,</span><span style="color: rgb(167, 9, 245);">'trellis'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi_nf3 = bml_roi_table(info_nf3,</span><span style="color: rgb(167, 9, 245);">'trellis'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi_nf6 = bml_roi_table(info_nf6,</span><span style="color: rgb(167, 9, 245);">'trellis'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi_ripple = bml_annot_rowbind(roi_nev, roi_ns5, roi_nf3, roi_nf6);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%ripple time after solid translation to GTC is master time</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_ripple = roi_ripple; </span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >bml_annot_write_tsv(sync_ripple, [PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION  </span><span style="color: rgb(167, 9, 245);">'_sync-ripple.tsv'</span><span >])</span></span></div></div></div><h2  class = 'S4'><span>ADDING TIME FROM ORIGINAL WAV FILES TO DERIVED WAV FILES</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >info_wav_src_times = info_wav_src(endsWith(info_wav_src.name,</span><span style="color: rgb(167, 9, 245);">'LR.WAV'</span><span >),:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav_src_times.duration_round = round(info_wav_src_times.duration,1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav_src_times.starts_src = info_wav_src_times.starts;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav_src_times.date_src = info_wav_src_times.date;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav_src_times.datenum_src = info_wav_src_times.datenum;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.duration_round = round(info_wav.duration,1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%info_wav = info_wav(:,setdiff(info_wav.Properties.VariableNames,info_date_vars))</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.keys={</span><span style="color: rgb(167, 9, 245);">'duration_round'</span><span >};</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.select = {</span><span style="color: rgb(167, 9, 245);">'starts_src'</span><span >,</span><span style="color: rgb(167, 9, 245);">'date_src'</span><span >,</span><span style="color: rgb(167, 9, 245);">'datenum_src'</span><span >};</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav = bml_annot_left_join(cfg,info_wav,info_wav_src_times);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.starts = info_wav.starts_src;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.date = info_wav.date_src;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.datenum = info_wav.datenum_src;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.ends = info_wav.starts + info_wav.duration;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.id = [];</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >info_wav = bml_annot_table(info_wav);</span></span></div></div></div><h2  class = 'S4'><span>COARSE ALIGNMENT</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >roi_neuroomega = bml_roi_table(info_neuroomega,</span><span style="color: rgb(167, 9, 245);">'neuroomega'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi_wav = bml_roi_table(info_wav,</span><span style="color: rgb(167, 9, 245);">'audio'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi = bml_annot_rowbind(roi_neuroomega, roi_ripple, roi_wav);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% plot initial coarse alignment</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >figure;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.facet=</span><span style="color: rgb(167, 9, 245);">"filetype"</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >bml_annot_plot(cfg,roi,</span><span style="color: rgb(167, 9, 245);">'LineWidth'</span><span >,3)</span></span></div></div></div><h2  class = 'S4'><span>FIND LANDMARKS IN AUDIO</span></h2><div  class = 'S8'><span>The time in the zoom recorder is not guaranteed to have the same reference across runs (battery, change, time resets, etc). Might need to mark landmarks for every run. </span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%selecting files to explore from runs table</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >landmarks_task = </span><span style="color: rgb(167, 9, 245);">'lombard'</span><span >; </span><span style="color: rgb(0, 128, 19);">% which task will be used to find audio landmarks? </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >task_runs = runs(strcmp(runs.task, landmarks_task) &amp; strcmp(runs.session,</span><span style="color: rgb(167, 9, 245);">'intraop'</span><span >),:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >i = 2; </span><span style="color: rgb(0, 128, 19);">% MANUALLY select which run index to find landmarks in </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >fprintf(</span><span style="color: rgb(167, 9, 245);">'run idx =%d\n'</span><span >,task_runs.run(i))</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[]; </span><span style="color: rgb(0, 128, 19);">%ns5</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi=roi_ns5(contains(roi_ns5.name, sprintf(</span><span style="color: rgb(167, 9, 245);">'%s'</span><span >,string(task_runs.trellis(i)))),:); </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.channel=</span><span style="color: rgb(167, 9, 245);">'analog 2'</span><span >; </span><span style="color: rgb(0, 128, 19);">%'analog 2'=stimulus audio, 'analog 30'=produced audio</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >ns5_audio = bml_load_continuous(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi.name</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >bml_praat(ns5_audio);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[]; </span><span style="color: rgb(0, 128, 19);">%ZoomH6</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi=roi_wav(contains(roi_wav.name, [</span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-intraop_task-' </span><span >landmarks_task </span><span style="color: rgb(167, 9, 245);">'_run-' </span><span >sprintf(</span><span style="color: rgb(167, 9, 245);">'%02d'</span><span >, task_runs.run(i)) </span><span style="color: rgb(167, 9, 245);">'_recording-speaker_stim.wav'</span><span >]), :); </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >wav_audio = bml_load_continuous(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi.name</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >bml_praat(wav_audio);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[]; </span><span style="color: rgb(0, 128, 19);">%alphaomega</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi=roi_neuroomega(contains(roi_neuroomega.name,sprintf(</span><span style="color: rgb(167, 9, 245);">'%.3f'</span><span >,lombard_runs.MER_depth(i))), :); </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi=cfg.roi(2, :); </span><span style="color: rgb(0, 128, 19);">% you might have to tweak this number manually </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >wav_audio = bml_load_continuous(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi.name</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >bml_praat(wav_audio);</span></span></div></div></div><div  class = 'S9'><span></span></div><div  class = 'S8'><span>Create table manually</span></div><ul  class = 'S10'><li  class = 'S11'><span>eg, </span><span style=' font-weight: bold;'>sub-DM10XX_ses-intraop_task-lombard_annot-audio-landmarks.tsv</span></li><li  class = 'S11'><span>find EXACTLY ONE landmark per data stream�-eg, don�t find landmarks for two Lombard runs </span></li><li  class = 'S11'><span>task run filetype name landmark_time</span></li></ul><h2  class = 'S4'><span>ADJUST ROIs ACCORDING TO LANDMARKS</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >landmarks = bml_annot_read_tsv([PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-intraop_task-' </span><span >landmarks_task </span><span style="color: rgb(167, 9, 245);">'_annot-audio-landmarks.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%get current t0 for landmark files</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >landmarks.t0 = bml_map(landmarks.name,roi.name,roi.starts,NaN);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% adding reference to transform to global time coordinates</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >landmarks.landmark_gtc = landmarks.landmark_time + landmarks.t0;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >landmarks_wide = unstack(landmarks(:,{</span><span style="color: rgb(167, 9, 245);">'run'</span><span >,</span><span style="color: rgb(167, 9, 245);">'filetype'</span><span >,</span><span style="color: rgb(167, 9, 245);">'landmark_gtc'</span><span >}),</span><span style="color: rgb(167, 9, 245);">'landmark_gtc'</span><span >,</span><span style="color: rgb(167, 9, 245);">'filetype'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% calculating corrections</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >landmarks_wide.neuroomega_delta = landmarks_wide.trellis_ns5 - landmarks_wide.neuroomega_mat;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >landmarks_wide.audio_delta = landmarks_wide.trellis_ns5 - landmarks_wide.audio_wav;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%correcting info tables using ns5 as master time</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cinfo_neuroomega=info_neuroomega;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cinfo_neuroomega.starts = info_neuroomega.starts + nanmean(landmarks_wide.neuroomega_delta);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cinfo_neuroomega.ends = info_neuroomega.ends + nanmean(landmarks_wide.neuroomega_delta);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cinfo_wav=info_wav;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cinfo_wav.starts = info_wav.starts + nanmean(landmarks_wide.audio_delta);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cinfo_wav.ends = info_wav.ends + nanmean(landmarks_wide.audio_delta);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% transforming to ROI tables</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi_neuroomega = bml_roi_table(cinfo_neuroomega,</span><span style="color: rgb(167, 9, 245);">'neuroomega'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >roi_wav = bml_roi_table(cinfo_wav,</span><span style="color: rgb(167, 9, 245);">'audio'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% merging roi tables</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >roi = bml_annot_rowbind(roi_neuroomega, roi_ripple, roi_wav);</span></span></div></div></div><h2  class = 'S4'><span>PLOT AND VERIFY COARSE ALIGNMENTS. SAVE FIGURE</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >f=figure();</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.facet=</span><span style="color: rgb(167, 9, 245);">"filetype"</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >bml_annot_plot(cfg,roi,</span><span style="color: rgb(167, 9, 245);">'LineWidth'</span><span >,3)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >saveas(f,[</span><span style="color: rgb(167, 9, 245);">'figures/sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION </span><span style="color: rgb(167, 9, 245);">'_proto-A04-coarse-sync.png'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >bml_annot_write_tsv(roi, [PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION </span><span style="color: rgb(167, 9, 245);">'_data-files-coarse-sync.tsv'</span><span >])</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'>&nbsp;</div></div></div><h2  class = 'S4'><span>DETECT  STRETCHES CONSTANT DEPTH IN ALPHA OMEGA</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.criterion = @(x) length(unique(x.depth))==1 &amp;&amp; abs((max(x.ends)-min(x.starts))-sum(x.duration))&lt;.001;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >neuro_cons_depth = bml_annot_consolidate(cfg,roi_neuroomega);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >ao_session = neuro_cons_depth(neuro_cons_depth.duration &gt; 30,:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >ao_session = ao_session(:,{</span><span style="color: rgb(167, 9, 245);">'starts'</span><span >,</span><span style="color: rgb(167, 9, 245);">'ends'</span><span >,</span><span style="color: rgb(167, 9, 245);">'depth'</span><span >});</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >bml_annot_write_tsv(ao_session,[PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION </span><span style="color: rgb(167, 9, 245);">'_stable-MER.tsv'</span><span >]);</span></span></div></div></div><h2  class = 'S4'><span>LOAD MASTER EVENTS</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%loading master events from all nev files</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >master_events = table();</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">for </span><span >i=1:height(info_nev)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    E=ft_read_event(fullfile(info_nev.folder{i},info_nev.name{i}),</span><span style="color: rgb(167, 9, 245);">'detectflank'</span><span >,</span><span style="color: rgb(167, 9, 245);">'both'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    hdr = ft_read_header(fullfile(info_nev.folder{i},info_nev.name{i}));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    cfg=[]; cfg.Fs = 1; </span><span style="color: rgb(0, 128, 19);">%already in seconds</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    cfg.starts = info_nev.starts(i);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    master_events_i = bml_event2annot(cfg,E);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">if </span><span >~isempty(master_events_i)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        master_events_i.value = master_events_i.value - 1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        master_events_i.sample = round(master_events_i.starts .* hdr.Fs);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        master_events_i.file_id(:) = i;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        master_events = bml_annot_rowbind(master_events,master_events_i);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% filter events </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >master_events.tmp = [2^15;abs(diff(master_events.value))];</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >master_events = master_events(master_events.tmp &gt;= 2^9,:);</span></span></div></div></div><h2  class = 'S4'><span>SYNCHRONIZING EVENT FILES TO RIPPLE EVENTS</span></h2><div  class = 'S8'><span>Will inherit exact timing from ripple. looping through events_files</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >events_files.delta_t(:)=nan;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >events_files.min_cost(:)=nan;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >events_files.warpfactor(:)=nan;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >events_files.n(:)=nan;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">for </span><span >i=1:height(events_files)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(0, 128, 19);">%selecting nev files that correspond to this events_files. </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    nev_events_files = bml_annot_filter(roi_nev,bml_annot_extend(events_files(i,:),events_files.duration(i) .* 1e-3));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">if </span><span >~isempty(nev_events_files)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%nev_events_files = nev_events_files(2,:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        task_events = bml_annot_read_tsv(fullfile(events_files.path{i},events_files.filename{i}));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%loading events from nev file</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        nev = table();</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">for </span><span >j = 1:height(nev_events_files)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            E = ft_read_event(fullfile(nev_events_files.folder{j},nev_events_files.name{j}),</span><span style="color: rgb(167, 9, 245);">'detectflank'</span><span >,</span><span style="color: rgb(167, 9, 245);">'both'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            cfg=[]; cfg.Fs = 1; </span><span style="color: rgb(0, 128, 19);">%already in seconds</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            cfg.starts = nev_events_files.t1(j) - (nev_events_files.s1(j)-1)./nev_events_files.Fs(j);;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            nev_j = bml_event2annot(cfg,E);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            nev_j.value = nev_j.value - 1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            nev_j = bml_annot_filter(nev_j,bml_annot_extend(events_files(i,:),1));   </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            nev = bml_annot_rowbind(nev,nev_j);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >   </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% plot(nev.starts,nev.starts - task_events.starts)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%Aligning events to ripple</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        cfg=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        cfg.scan = 1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        cfg.timewarp = true;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        [slave_delta_t, min_cost, warpfactor] = bml_timealign_annot(cfg, nev, task_events);   </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        n = height(task_events);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        events_files.delta_t(i)=slave_delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        events_files.min_cost(i)=min_cost;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        events_files.warpfactor(i)=warpfactor;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        events_files.n(i)=n;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">if </span><span >(height(nev) == height(task_events)) &amp;&amp; all(nev.value == task_events.value) &amp;&amp; min_cost/n &lt; 0.01</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            task_events.starts = nev.starts;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            task_events.ends = task_events.starts + task_events.duration;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            bml_annot_write_tsv(task_events,[PATH_ANNOT filesep strrep(events_files.filename{i},</span><span style="color: rgb(167, 9, 245);">'.tsv'</span><span >,</span><span style="color: rgb(167, 9, 245);">'-sync.tsv'</span><span >)]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            fprintf(</span><span style="color: rgb(167, 9, 245);">'sync %s, delta_t=%f, avg cost=%f, warpfactor=%f \n'</span><span >,events_files.filename{i}, slave_delta_t, min_cost/n, warpfactor)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">elseif </span><span >(height(nev) &lt; height(task_events)) &amp;&amp; height(nev_events_files)==2 </span><span style="color: rgb(0, 128, 19);">% events missing in nev (2 nev files for a events files)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(0, 128, 19);">%applying timealignment to events as fallback strategy</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            tbar = mean(task_events.starts);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            task_events.starts_corrected = (task_events.starts - tbar) .* warpfactor + tbar + slave_delta_t;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(0, 128, 19);">%finding alingment between events</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            [nev_idxs, task_events_idxs] = find_mincost_indices(nev.value, task_events.value);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(0, 128, 19);">%getting time from nev according to alignemnt (when available)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            task_events.starts = bml_map(1:height(task_events),task_events_idxs,nev.starts(nev_idxs),nan);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            </span><span style="color: rgb(0, 128, 19);">%using fallback times when nev times not available</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            task_events.starts(isnan(task_events.starts))=task_events.starts_corrected(isnan(task_events.starts));</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            bml_annot_write_tsv(task_events,[PATH_ANNOT filesep strrep(events_files.filename{i},</span><span style="color: rgb(167, 9, 245);">'.tsv'</span><span >,</span><span style="color: rgb(167, 9, 245);">'-not-sync.tsv'</span><span >)]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >            fprintf(</span><span style="color: rgb(167, 9, 245);">'sync %s, delta_t=%f, avg cost=%f, warpfactor=%f (maximizing matching indices) \n'</span><span >, events_files.filename{i}, slave_delta_t, min_cost, warpfactor);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >        </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div></div><h2  class = 'S4'><span>SYNCHRONIZE ZOOM WITH EVENTS USING DIGITAL TRIGGERS</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >TASKS = {</span><span style="color: rgb(167, 9, 245);">'sync'</span><span >, </span><span style="color: rgb(167, 9, 245);">'lombard'</span><span >, </span><span style="color: rgb(167, 9, 245);">'smsl'</span><span >}; </span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg =[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.master_events = master_events;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi = roi_wav(contains(roi_wav.name,</span><span style="color: rgb(167, 9, 245);">'_events.wav'</span><span >) &amp; contains(roi_wav.name,TASKS) ,:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.timewarp = true;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.diagnostic_plot = true;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.timetol = 0.001;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.coarsetol = 0.001;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.restrict_master_by = </span><span style="color: rgb(167, 9, 245);">'file_id'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_wav = bml_sync_audio_event(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >savefig([</span><span style="color: rgb(167, 9, 245);">'./figures' </span><span >filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-intraop_proto-A04-fine-sync-audio_' </span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    char(string(datestr(now, </span><span style="color: rgb(167, 9, 245);">'YYYYmmDDMM'</span><span >))) </span><span style="color: rgb(167, 9, 245);">'.fig'</span><span >])</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >bml_annot_write_tsv(sync_wav,[PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION </span><span style="color: rgb(167, 9, 245);">'_task-' </span><span >TASK </span><span style="color: rgb(167, 9, 245);">'_sync-audio.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%not synching the calibration</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_audio_cons = sync_wav(~contains(sync_wav.name,</span><span style="color: rgb(167, 9, 245);">'calibration'</span><span >),:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav = info_wav(~contains(info_wav.name,</span><span style="color: rgb(167, 9, 245);">'calibration'</span><span >),:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% matching files by basename</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >tmp = regexp(sync_audio_cons.name,</span><span style="color: rgb(167, 9, 245);">'^(sub-[\w]*_ses-[\w]*_task-[\w]*_run-[0-9]*)_[\w-\.]*$'</span><span >,</span><span style="color: rgb(167, 9, 245);">'tokens'</span><span >,</span><span style="color: rgb(167, 9, 245);">'once'</span><span >,</span><span style="color: rgb(167, 9, 245);">'forceCellOutput'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_audio_cons.basename  = [tmp{:}]';</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >tmp = regexp(info_wav.name,</span><span style="color: rgb(167, 9, 245);">'^(sub-[\w]*_ses-[\w]*_task-[\w]*_run-[0-9]*)_[\w-\.]*$'</span><span >,</span><span style="color: rgb(167, 9, 245);">'tokens'</span><span >,</span><span style="color: rgb(167, 9, 245);">'once'</span><span >,</span><span style="color: rgb(167, 9, 245);">'forceCellOutput'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.basename  = [tmp{:}]';</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >tmp=regexp(info_wav.name,</span><span style="color: rgb(167, 9, 245);">'^sub-[\w]*_ses-[\w]*_task-[\w]*_run-[0-9]*_(recording-)?([a-zA-Z0-9-]*)(_[\w]*)?\.wav$'</span><span >,</span><span style="color: rgb(167, 9, 245);">'tokens'</span><span >,</span><span style="color: rgb(167, 9, 245);">'once'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav.chantype=cellfun(@(x) x(2),tmp);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% transfering sync to other wav files</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_audio_all = table();</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">for </span><span >i=1:height(sync_audio_cons)</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    sel_info_wav = info_wav(strcmp(info_wav.basename,sync_audio_cons.basename(i)),:);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    sync_audio_i = repmat(sync_audio_cons(i,:),[height(sel_info_wav),1]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    sync_audio_i.name = sel_info_wav.name;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    sync_audio_i.nSamples = sel_info_wav.nSamples;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    sync_audio_i.chantype = sel_info_wav.chantype;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    </span><span style="color: rgb(0, 128, 19);">%sync_audio_i.fullfile = [];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >    sync_audio_all = bml_annot_rowbind(sync_audio_all,sync_audio_i);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">end</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >bml_annot_write_tsv(sync_audio_all,[PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION </span><span style="color: rgb(167, 9, 245);">'_sync-audio-all.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'>&nbsp;</div></div></div><h2  class = 'S4'><span>SYNCHRONIZE NEUROOMEGA FILE WITH EVENTS USING DIGITAL TRIGGERS</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >cfg = [];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.master_events = master_events;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.roi = roi_neuroomega;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.timewarp = true;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.diagnostic_plot = true;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.timetol = 0.0003;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >cfg.coarsetol = 0.001;</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_ao = bml_sync_neuroomega_event(cfg);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >bml_annot_write_tsv(sync_ao,[PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION </span><span style="color: rgb(167, 9, 245);">'_sync-alphaomega.tsv'</span><span >]);</span></span></div></div></div><h2  class = 'S4'><span>COMBINING SYNC ENTRIES INTO UNIQUE TABLE</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >sync = bml_annot_rowbind(sync_audio_all, sync_ripple, sync_ao);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">%sync = bml_annot_rowbind(sync_audio_all, sync_ripple);</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >bml_annot_write_tsv(sync,[PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-' </span><span >SESSION </span><span style="color: rgb(167, 9, 245);">'_sync.tsv'</span><span >]);</span></span></div></div></div><h2  class = 'S4'><span>VERIFYING ALL TABLES HAVE BEEN WRITTEN PROPERLY</span></h2><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S1'><span style="white-space: pre"><span >sync_alphaomega = bml_annot_read_tsv([PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-intraop_sync-alphaomega.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_ripple = bml_annot_read_tsv([PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-intraop_task-lombard_sync-ripple.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_wav = bml_annot_read_tsv([PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-intraop_task-lombard_sync-audio.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >sync_wav.date_src=[];</span></span></div></div><div class="inlineWrapper"><div  class = 'S2'><span style="white-space: pre"><span >info_wav =  bml_annot_read_tsv([PATH_ANNOT filesep </span><span style="color: rgb(167, 9, 245);">'sub-' </span><span >SUBJECT </span><span style="color: rgb(167, 9, 245);">'_ses-intraop_task-lombard_data-files-coarse-sync.tsv'</span><span >]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >info_wav = info_wav(info_wav.filetype==</span><span style="color: rgb(167, 9, 245);">"audio.wav"</span><span >,:);</span></span></div></div></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% LOADING TOOLBOXES

ft_defaults
bml_defaults
format long
clear
%% DEFINING PATHS

SUBJECT='DM10XX';
SESSION='intraop';

% this first part of this script is not task-specific
% TASK='lombard';

PATH_DATASET = 'Y:\DBS';
PATH_DER = [PATH_DATASET filesep 'derivatives'];
PATH_DER_SUB = [PATH_DER filesep 'sub-' SUBJECT];  
PATH_PREPROC = [PATH_DER_SUB filesep 'preproc'];
PATH_ANNOT = [PATH_DER_SUB filesep 'annot'];
PATH_SRC = [PATH_DATASET filesep 'sourcedata'];
PATH_SRC_SUB = [PATH_SRC filesep 'sub-' SUBJECT];   
PATH_RIPPLE = [PATH_SRC_SUB filesep 'ses-intraop' filesep 'ripple'];
PATH_ANALOG = [PATH_SRC_SUB filesep 'ses-intraop' filesep 'analog'];
PATH_ALHAOMEGA = [PATH_SRC_SUB filesep 'ses-intraop' filesep 'alphaomega']; %path to neuroomega's mpx files.
PATH_ALHAOMEGA_MAT = [PATH_ALHAOMEGA]; %path to neuroomega's converted mat files.
PATH_AUDIO_DER = [PATH_DER_SUB filesep 'aec']; %path to acoustic echo cancelling folder
PATHS_AUDIO_SRC = strcat(PATH_SRC_SUB,filesep,{'ses-training';'ses-preop';'ses-intraop'},filesep,'audio');
PATHS_TASK = strcat(PATH_SRC_SUB,filesep,{'ses-training';'ses-preop';'ses-intraop'},filesep,'task');

% loading annotation tables
events_files = bml_annot_read_tsv([PATH_ANNOT filesep 'sub-' SUBJECT '_events-files.tsv']);
% events_files.path = strrep(events_files.path,'/Volumes/Nexus4','Y:');
session = bml_annot_read_tsv([PATH_ANNOT filesep 'sub-' SUBJECT '_sessions.tsv']);
runs = bml_annot_read_tsv([PATH_ANNOT filesep 'sub-' SUBJECT '_runs.tsv']);
cd(PATH_PREPROC)
%% LOADING HEADER INFORMATION

cfg=[];
cfg.path=PATH_RIPPLE;
cfg.pattern='*.nev';
cfg.filetype='trellis.nev';
info_nev=bml_info_raw(cfg);
info_nev.basename = strrep(info_nev.name,'.nev','');

cfg=[];
cfg.path=PATH_RIPPLE;
cfg.pattern='*.ns5';
cfg.filetype='trellis.ns5';
info_ns5=bml_info_raw(cfg);
info_ns5.basename = strrep(info_ns5.name,'.ns5','');

cfg=[];
cfg.path=PATH_RIPPLE;
cfg.pattern='*.nf3';
cfg.filetype='trellis.nf3';
info_nf3=bml_info_raw(cfg);
info_nf3.chantype(:) = {'hires'};
info_nf3.basename = strrep(info_nf3.name,'.nf3','');

cfg=[];
cfg.path=PATH_RIPPLE;
cfg.pattern='*.nf6';
cfg.filetype='trellis.nf6';
info_nf6=bml_info_raw(cfg);
info_nf6.chantype(:) = {'hifreq'};
info_nf6.basename = strrep(info_nf6.name,'.nf6','');

cfg=[];
cfg.mpx_path=PATH_ALHAOMEGA;
cfg.path=PATH_ALHAOMEGA_MAT;
cfg.filetype='neuroomega.mat';
cfg.chantype='analog';
info_neuroomega=bml_neuroomega_info_raw(cfg);
info_neuroomega.basename = strrep(info_neuroomega.name,'.mat','');

info_wav_src=[];
info_wav_src_renamed=[];
for i=1:length(PATHS_AUDIO_SRC)
    cfg=[];
    cfg.path=PATHS_AUDIO_SRC{i};
    cfg.pattern='ZOOM*/*.wav';
    cfg.filetype='audio.wav';
    info_wav_src=bml_annot_rowbind(info_wav_src,bml_info_raw(cfg));

cfg.pattern='sub-*.wav';
    info_wav_src_renamed=bml_annot_rowbind(info_wav_src_renamed,bml_info_raw(cfg));
end

info_wav_src.basename = strrep(info_wav_src.name,'.WAV','');
info_wav_src_renamed.basename = strrep(info_wav_src_renamed.name,'.wav','');
cfg=[];
cfg.path=PATH_AUDIO_DER;
cfg.pattern='*.wav';
cfg.filetype='audio.wav';
info_wav=bml_info_raw(cfg);
info_wav.basename = strrep(info_wav.name,'.wav','');
info_wav = info_wav(~ismember(info_wav.name,info_wav_src_renamed.name),:);
info_wav = bml_annot_rowbind(info_wav_src_renamed,info_wav);


% Saving files information table with OS times
info_orig = bml_annot_rowbind(info_ns5,info_nf3,info_nf6,info_nev,info_neuroomega,info_wav,info_wav_src);
bml_annot_write_tsv(info_orig, [PATH_ANNOT filesep 'sub-' SUBJECT '_ses-' SESSION '_data-files-orig.tsv']);
%% ALIGNING TRELLIS FILES TO EVENTS BY SCRIPTS (NO TIME WARPING)
% looping through nev files

info_nev.delta_t(:) = nan;
info_nev.min_cost(:) = nan;
info_nev.n(:) = nan;
for i=1:height(info_nev)
    %selecting events files that correspond to this nev file. Doing this by
    %coarse time
    
    nev_events_files = bml_annot_filter(events_files,info_nev(i,:));
    if ~isempty(nev_events_files)
        task_events = table();
        for j = 1:height(nev_events_files)
            % changed LB 20231019, sync file and lombard file couldn't be
            % concatenated because sync.stim_file was all nans
            events_tmp = bml_annot_read_tsv(fullfile(nev_events_files.path{j},nev_events_files.filename{j})); 
            if isnumeric(events_tmp.stim_file) && all(isnan(events_tmp.stim_file)); events_tmp.stim_file = repmat({''}, height(events_tmp), 1); end
            task_events = bml_annot_rowbind(task_events, events_tmp);
        end
        %loading events from nev file
        E = ft_read_event(fullfile(info_nev.folder{i},info_nev.name{i}),'detectflank','both');
        hdr = ft_read_header(fullfile(info_nev.folder{i},info_nev.name{i}));
        cfg=[]; cfg.Fs = 1; %already in seconds
        cfg.starts = info_nev.starts(i);
        nev = bml_event2annot(cfg,E);
        nev.value = nev.value - 1;
        nev.sample = round(nev.starts .* hdr.Fs);
        
        % plot(nev.starts,nev.starts - task_events.starts)
        
        %Aligning blackrock to presenation task to get GTC. No timewarping.
        cfg=[];
        cfg.scan = 100;
        [slave_delta_t, min_cost, warpfactor] = bml_timealign_annot(cfg, task_events, nev);
        
        info_nev.delta_t(i)=slave_delta_t;
        info_nev.min_cost(i)=min_cost;
        info_nev.n(i)=height(nev);
        
        fprintf('%f sec, min cost = %f\n', slave_delta_t, min_cost)
    end
end
%adjusting ripple files
info_nev.delta_t(ismissing(info_nev.delta_t)) = 0;
cfg.keys = 'basename';
info_ns5 = bml_annot_left_join(cfg,info_ns5,info_nev(:,{'basename','delta_t'}));
info_nf3 = bml_annot_left_join(cfg,info_nf3,info_nev(:,{'basename','delta_t'}));
info_nf6 = bml_annot_left_join(cfg,info_nf6,info_nev(:,{'basename','delta_t'}));
info_nev.starts = info_nev.starts + info_nev.delta_t;
info_nev.ends = info_nev.ends + info_nev.delta_t;
info_ns5.starts = info_ns5.starts + info_ns5.delta_t;
info_ns5.ends = info_ns5.ends + info_ns5.delta_t;
info_nf3.starts = info_nf3.starts + info_nf3.delta_t;
info_nf3.ends = info_nf3.ends + info_nf3.delta_t;
info_nf6.starts = info_nf6.starts + info_nf6.delta_t;
info_nf6.ends = info_nf6.ends + info_nf6.delta_t;
roi_nev = bml_roi_table(info_nev,'trellis');
roi_ns5 = bml_roi_table(info_ns5,'trellis');
roi_nf3 = bml_roi_table(info_nf3,'trellis');
roi_nf6 = bml_roi_table(info_nf6,'trellis');
roi_ripple = bml_annot_rowbind(roi_nev, roi_ns5, roi_nf3, roi_nf6);
%ripple time after solid translation to GTC is master time
sync_ripple = roi_ripple; 
bml_annot_write_tsv(sync_ripple, [PATH_ANNOT filesep 'sub-' SUBJECT '_ses-' SESSION  '_sync-ripple.tsv'])
%% ADDING TIME FROM ORIGINAL WAV FILES TO DERIVED WAV FILES

info_wav_src_times = info_wav_src(endsWith(info_wav_src.name,'LR.WAV'),:);
info_wav_src_times.duration_round = round(info_wav_src_times.duration,1);
info_wav_src_times.starts_src = info_wav_src_times.starts;
info_wav_src_times.date_src = info_wav_src_times.date;
info_wav_src_times.datenum_src = info_wav_src_times.datenum;
info_wav.duration_round = round(info_wav.duration,1);
%info_wav = info_wav(:,setdiff(info_wav.Properties.VariableNames,info_date_vars))

cfg=[];
cfg.keys={'duration_round'};
cfg.select = {'starts_src','date_src','datenum_src'};
info_wav = bml_annot_left_join(cfg,info_wav,info_wav_src_times);
info_wav.starts = info_wav.starts_src;
info_wav.date = info_wav.date_src;
info_wav.datenum = info_wav.datenum_src;
info_wav.ends = info_wav.starts + info_wav.duration;
info_wav.id = [];
info_wav = bml_annot_table(info_wav);
%% COARSE ALIGNMENT

roi_neuroomega = bml_roi_table(info_neuroomega,'neuroomega');
roi_wav = bml_roi_table(info_wav,'audio');

roi = bml_annot_rowbind(roi_neuroomega, roi_ripple, roi_wav);
% plot initial coarse alignment
figure;
cfg=[];
cfg.facet="filetype";
bml_annot_plot(cfg,roi,'LineWidth',3)
%% FIND LANDMARKS IN AUDIO
% The time in the zoom recorder is not guaranteed to have the same reference 
% across runs (battery, change, time resets, etc). Might need to mark landmarks 
% for every run. 

%selecting files to explore from runs table
landmarks_task = 'lombard'; % which task will be used to find audio landmarks? 
task_runs = runs(strcmp(runs.task, landmarks_task) & strcmp(runs.session,'intraop'),:);

i = 2; % MANUALLY select which run index to find landmarks in 

fprintf('run idx =%d\n',task_runs.run(i))
cfg=[]; %ns5
cfg.roi=roi_ns5(contains(roi_ns5.name, sprintf('%s',string(task_runs.trellis(i)))),:); 
cfg.channel='analog 2'; %'analog 2'=stimulus audio, 'analog 30'=produced audio
ns5_audio = bml_load_continuous(cfg);
cfg.roi.name
bml_praat(ns5_audio);

cfg=[]; %ZoomH6
cfg.roi=roi_wav(contains(roi_wav.name, ['sub-' SUBJECT '_ses-intraop_task-' landmarks_task '_run-' sprintf('%02d', task_runs.run(i)) '_recording-speaker_stim.wav']), :); 
wav_audio = bml_load_continuous(cfg);
cfg.roi.name
bml_praat(wav_audio);
    
cfg=[]; %alphaomega
cfg.roi=roi_neuroomega(contains(roi_neuroomega.name,sprintf('%.3f',lombard_runs.MER_depth(i))), :); 
cfg.roi=cfg.roi(2, :); % you might have to tweak this number manually 
wav_audio = bml_load_continuous(cfg);
cfg.roi.name
bml_praat(wav_audio);
%% 
% 
% 
% Create table manually
%% 
% * eg, *sub-DM10XX_ses-intraop_task-lombard_annot-audio-landmarks.tsv*
% * find EXACTLY ONE landmark per data stream�-eg, don�t find landmarks for 
% two Lombard runs 
% * task run filetype name landmark_time
%% ADJUST ROIs ACCORDING TO LANDMARKS

landmarks = bml_annot_read_tsv([PATH_ANNOT filesep 'sub-' SUBJECT '_ses-intraop_task-' landmarks_task '_annot-audio-landmarks.tsv']);


%get current t0 for landmark files
landmarks.t0 = bml_map(landmarks.name,roi.name,roi.starts,NaN);

% adding reference to transform to global time coordinates
landmarks.landmark_gtc = landmarks.landmark_time + landmarks.t0;
landmarks_wide = unstack(landmarks(:,{'run','filetype','landmark_gtc'}),'landmark_gtc','filetype');

% calculating corrections
landmarks_wide.neuroomega_delta = landmarks_wide.trellis_ns5 - landmarks_wide.neuroomega_mat;
landmarks_wide.audio_delta = landmarks_wide.trellis_ns5 - landmarks_wide.audio_wav;


%correcting info tables using ns5 as master time
cinfo_neuroomega=info_neuroomega;
cinfo_neuroomega.starts = info_neuroomega.starts + nanmean(landmarks_wide.neuroomega_delta);
cinfo_neuroomega.ends = info_neuroomega.ends + nanmean(landmarks_wide.neuroomega_delta);

cinfo_wav=info_wav;
cinfo_wav.starts = info_wav.starts + nanmean(landmarks_wide.audio_delta);
cinfo_wav.ends = info_wav.ends + nanmean(landmarks_wide.audio_delta);

% transforming to ROI tables
roi_neuroomega = bml_roi_table(cinfo_neuroomega,'neuroomega');
roi_wav = bml_roi_table(cinfo_wav,'audio');

% merging roi tables
roi = bml_annot_rowbind(roi_neuroomega, roi_ripple, roi_wav);
%% PLOT AND VERIFY COARSE ALIGNMENTS. SAVE FIGURE

f=figure();
cfg=[];
cfg.facet="filetype";
bml_annot_plot(cfg,roi,'LineWidth',3)
saveas(f,['figures/sub-' SUBJECT '_ses-' SESSION '_proto-A04-coarse-sync.png']);
bml_annot_write_tsv(roi, [PATH_ANNOT filesep 'sub-' SUBJECT '_ses-' SESSION '_data-files-coarse-sync.tsv'])

%% DETECT  STRETCHES CONSTANT DEPTH IN ALPHA OMEGA


cfg=[];
cfg.criterion = @(x) length(unique(x.depth))==1 && abs((max(x.ends)-min(x.starts))-sum(x.duration))<.001;
neuro_cons_depth = bml_annot_consolidate(cfg,roi_neuroomega);
ao_session = neuro_cons_depth(neuro_cons_depth.duration > 30,:);
ao_session = ao_session(:,{'starts','ends','depth'});
bml_annot_write_tsv(ao_session,[PATH_ANNOT filesep 'sub-' SUBJECT '_ses-' SESSION '_stable-MER.tsv']);
%% LOAD MASTER EVENTS

%loading master events from all nev files
master_events = table();
for i=1:height(info_nev)

    E=ft_read_event(fullfile(info_nev.folder{i},info_nev.name{i}),'detectflank','both');
    hdr = ft_read_header(fullfile(info_nev.folder{i},info_nev.name{i}));
    cfg=[]; cfg.Fs = 1; %already in seconds
    cfg.starts = info_nev.starts(i);
    master_events_i = bml_event2annot(cfg,E);
    if ~isempty(master_events_i)
        master_events_i.value = master_events_i.value - 1;
        master_events_i.sample = round(master_events_i.starts .* hdr.Fs);
        master_events_i.file_id(:) = i;
        master_events = bml_annot_rowbind(master_events,master_events_i);
    end

end

% filter events 
master_events.tmp = [2^15;abs(diff(master_events.value))];
master_events = master_events(master_events.tmp >= 2^9,:);
%% SYNCHRONIZING EVENT FILES TO RIPPLE EVENTS
% Will inherit exact timing from ripple. looping through events_files

events_files.delta_t(:)=nan;
events_files.min_cost(:)=nan;
events_files.warpfactor(:)=nan;
events_files.n(:)=nan;
for i=1:height(events_files)
    %selecting nev files that correspond to this events_files. 
    nev_events_files = bml_annot_filter(roi_nev,bml_annot_extend(events_files(i,:),events_files.duration(i) .* 1e-3));
    
    if ~isempty(nev_events_files)
        %nev_events_files = nev_events_files(2,:);
        task_events = bml_annot_read_tsv(fullfile(events_files.path{i},events_files.filename{i}));
        %loading events from nev file
        nev = table();
        for j = 1:height(nev_events_files)
            E = ft_read_event(fullfile(nev_events_files.folder{j},nev_events_files.name{j}),'detectflank','both');
            cfg=[]; cfg.Fs = 1; %already in seconds
            cfg.starts = nev_events_files.t1(j) - (nev_events_files.s1(j)-1)./nev_events_files.Fs(j);;
            nev_j = bml_event2annot(cfg,E);
            nev_j.value = nev_j.value - 1;
            nev_j = bml_annot_filter(nev_j,bml_annot_extend(events_files(i,:),1));   
            nev = bml_annot_rowbind(nev,nev_j);
        end
   
        % plot(nev.starts,nev.starts - task_events.starts)
        
        %Aligning events to ripple
        cfg=[];
        cfg.scan = 1;
        cfg.timewarp = true;
        [slave_delta_t, min_cost, warpfactor] = bml_timealign_annot(cfg, nev, task_events);   
        n = height(task_events);
        events_files.delta_t(i)=slave_delta_t;
        events_files.min_cost(i)=min_cost;
        events_files.warpfactor(i)=warpfactor;
        events_files.n(i)=n;
        
        if (height(nev) == height(task_events)) && all(nev.value == task_events.value) && min_cost/n < 0.01
            task_events.starts = nev.starts;
            task_events.ends = task_events.starts + task_events.duration;
            bml_annot_write_tsv(task_events,[PATH_ANNOT filesep strrep(events_files.filename{i},'.tsv','-sync.tsv')]);
            fprintf('sync %s, delta_t=%f, avg cost=%f, warpfactor=%f \n',events_files.filename{i}, slave_delta_t, min_cost/n, warpfactor)
        
        elseif (height(nev) < height(task_events)) && height(nev_events_files)==2 % events missing in nev (2 nev files for a events files)
            
            %applying timealignment to events as fallback strategy
            tbar = mean(task_events.starts);
            task_events.starts_corrected = (task_events.starts - tbar) .* warpfactor + tbar + slave_delta_t;

            %finding alingment between events
            [nev_idxs, task_events_idxs] = find_mincost_indices(nev.value, task_events.value);
            
            %getting time from nev according to alignemnt (when available)
            task_events.starts = bml_map(1:height(task_events),task_events_idxs,nev.starts(nev_idxs),nan);

            %using fallback times when nev times not available
            task_events.starts(isnan(task_events.starts))=task_events.starts_corrected(isnan(task_events.starts));

            bml_annot_write_tsv(task_events,[PATH_ANNOT filesep strrep(events_files.filename{i},'.tsv','-not-sync.tsv')]);
            fprintf('sync %s, delta_t=%f, avg cost=%f, warpfactor=%f (maximizing matching indices) \n', events_files.filename{i}, slave_delta_t, min_cost, warpfactor);
        end
    end
end
%% SYNCHRONIZE ZOOM WITH EVENTS USING DIGITAL TRIGGERS

TASKS = {'sync', 'lombard', 'smsl'}; 

cfg =[];
cfg.master_events = master_events;
cfg.roi = roi_wav(contains(roi_wav.name,'_events.wav') & contains(roi_wav.name,TASKS) ,:);
cfg.timewarp = true;
cfg.diagnostic_plot = true;
cfg.timetol = 0.001;
cfg.coarsetol = 0.001;
cfg.restrict_master_by = 'file_id';
sync_wav = bml_sync_audio_event(cfg);

savefig(['./figures' filesep 'sub-' SUBJECT '_ses-intraop_proto-A04-fine-sync-audio_' ...
    char(string(datestr(now, 'YYYYmmDDMM'))) '.fig'])

bml_annot_write_tsv(sync_wav,[PATH_ANNOT filesep 'sub-' SUBJECT '_ses-' SESSION '_task-' TASK '_sync-audio.tsv']);

%not synching the calibration
sync_audio_cons = sync_wav(~contains(sync_wav.name,'calibration'),:);
info_wav = info_wav(~contains(info_wav.name,'calibration'),:);

% matching files by basename
tmp = regexp(sync_audio_cons.name,'^(sub-[\w]*_ses-[\w]*_task-[\w]*_run-[0-9]*)_[\w-\.]*$','tokens','once','forceCellOutput');
sync_audio_cons.basename  = [tmp{:}]';
tmp = regexp(info_wav.name,'^(sub-[\w]*_ses-[\w]*_task-[\w]*_run-[0-9]*)_[\w-\.]*$','tokens','once','forceCellOutput');
info_wav.basename  = [tmp{:}]';
tmp=regexp(info_wav.name,'^sub-[\w]*_ses-[\w]*_task-[\w]*_run-[0-9]*_(recording-)?([a-zA-Z0-9-]*)(_[\w]*)?\.wav$','tokens','once');
info_wav.chantype=cellfun(@(x) x(2),tmp);

% transfering sync to other wav files
sync_audio_all = table();
for i=1:height(sync_audio_cons)
    sel_info_wav = info_wav(strcmp(info_wav.basename,sync_audio_cons.basename(i)),:);
    sync_audio_i = repmat(sync_audio_cons(i,:),[height(sel_info_wav),1]);
    sync_audio_i.name = sel_info_wav.name;
    sync_audio_i.nSamples = sel_info_wav.nSamples;
    sync_audio_i.chantype = sel_info_wav.chantype;
    %sync_audio_i.fullfile = [];
    sync_audio_all = bml_annot_rowbind(sync_audio_all,sync_audio_i);
end

bml_annot_write_tsv(sync_audio_all,[PATH_ANNOT filesep 'sub-' SUBJECT '_ses-' SESSION '_sync-audio-all.tsv']);

%% SYNCHRONIZE NEUROOMEGA FILE WITH EVENTS USING DIGITAL TRIGGERS

cfg = [];
cfg.master_events = master_events;
cfg.roi = roi_neuroomega;
cfg.timewarp = true;
cfg.diagnostic_plot = true;
cfg.timetol = 0.0003;
cfg.coarsetol = 0.001;
sync_ao = bml_sync_neuroomega_event(cfg);

bml_annot_write_tsv(sync_ao,[PATH_ANNOT filesep 'sub-' SUBJECT '_ses-' SESSION '_sync-alphaomega.tsv']);
%% COMBINING SYNC ENTRIES INTO UNIQUE TABLE

sync = bml_annot_rowbind(sync_audio_all, sync_ripple, sync_ao);
%sync = bml_annot_rowbind(sync_audio_all, sync_ripple);
bml_annot_write_tsv(sync,[PATH_ANNOT filesep 'sub-' SUBJECT '_ses-' SESSION '_sync.tsv']);
%% VERIFYING ALL TABLES HAVE BEEN WRITTEN PROPERLY

sync_alphaomega = bml_annot_read_tsv([PATH_ANNOT filesep 'sub-' SUBJECT '_ses-intraop_sync-alphaomega.tsv']);
sync_ripple = bml_annot_read_tsv([PATH_ANNOT filesep 'sub-' SUBJECT '_ses-intraop_task-lombard_sync-ripple.tsv']);
sync_wav = bml_annot_read_tsv([PATH_ANNOT filesep 'sub-' SUBJECT '_ses-intraop_task-lombard_sync-audio.tsv']);
sync_wav.date_src=[];
info_wav =  bml_annot_read_tsv([PATH_ANNOT filesep 'sub-' SUBJECT '_ses-intraop_task-lombard_data-files-coarse-sync.tsv']);
info_wav = info_wav(info_wav.filetype=="audio.wav",:);
##### SOURCE END #####
-->
</div></body></html>